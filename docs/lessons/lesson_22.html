<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Lesson 22: Chaining Task and Chat APIs - Merci SDK</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B600%3B700%3B900&family=Fira+Code%3Awght%40400" onload="this.rel='stylesheet'" rel="stylesheet"/>

    <!-- Scripts & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="../assets/css/style.css" rel="stylesheet">
</head>
<body>
<!-- Animated Aurora Background -->
<div class="aurora-background"></div>

<div class="flex min-h-screen flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 w-full border-b border-[var(--border-color)] bg-[var(--header-background)] backdrop-blur-lg transition-colors duration-300">
        <div class="container mx-auto flex flex-wrap items-center justify-between px-4 lg:px-8">
            <div class="flex h-16 items-center">
                <a class="flex items-center gap-2" href="../index.html">
                    <img src="../assets/images/merci-sdk-logo.png" alt="Merci SDK Logo" class="h-8 w-12">
                    <h1 class="text-xl font-bold text-[var(--text-primary)]">Merci SDK</h1>
                </a>
            </div>
            <div class="lg:hidden">
                <button id="menu-toggle" class="rounded p-2 text-[var(--text-secondary)] hover:bg-slate-200 dark:hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-[var(--primary-color)]">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
            <div id="menu-content" class="hidden w-full lg:flex lg:w-auto lg:items-center">
                <nav class="flex w-full flex-col gap-4 border-t border-[var(--border-color)] py-4 lg:w-auto lg:flex-row lg:items-center lg:gap-6 lg:border-none lg:py-0">
                    <a class="nav-link group" href="../index.html"><span>Overview</span></a>
                    <a class="nav-link group" href="../getting_started.html"><span>Getting Started</span></a>
                    <a class="nav-link-active group" href="../tutorials.html"><span>Tutorials</span></a>
                    <a class="nav-link group" href="../api_reference.html"><span>API Reference</span></a>
                </nav>
                <div class="w-full pb-4 lg:w-auto lg:pb-0 lg:pl-4">
                    <button type="button" class="theme-toggle-btn w-full text-sm font-semibold rounded-md px-3 py-1.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--background-color)] bg-slate-200 text-slate-800 hover:bg-slate-300 focus:ring-slate-500 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700 dark:focus:ring-slate-500">
                        <span class="theme-toggle-text">Dark Mode</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 sm:px-6 lg:px-8 flex-grow">
        <div class="max-w-4xl mx-auto">
            <div class="mb-8">
                <nav class="flex items-center gap-2 text-sm font-medium text-[var(--text-secondary)]">
                    <a class="hover:text-[var(--primary-color)] transition-colors" href="../tutorials.html">Tutorials</a>
                    <span>/</span>
                    <span class="text-[var(--text-primary)]">Lesson 22</span>
                </nav>
            </div>
            <article>
                <header class="mb-8">
                    <h1 class="text-3xl font-bold tracking-tight text-[var(--text-primary)] mb-2">Lesson 22: Chaining Task and Chat APIs</h1>
                    <p class="text-lg text-[var(--text-secondary)]">This lesson demonstrates a powerful workflow where the output of the Task API is used as the input for the Chat API, enabling complex, multi-step agentic behaviors.</p>
                </header>

                <section class="mb-12">
                    <h2>Code: <code class="inline"><a href="https://github.com/mobeetle/merci-sdk/tree/main/examples/lesson_22_chaining_task_and_chat.mjs">lesson_22_chaining_task_and_chat.mjs</a></code></h2>
                    <p class="text-[var(--text-secondary)] mb-4">This script first uses the `code-generate:default` task to create a simple (and slightly flawed) JavaScript function. It then feeds this generated code to a Chat-based "reviewer" agent, which analyzes the code and suggests improvements.</p>
                    <div class="code-block-wrapper">
                        <button class="copy-code-btn absolute top-3 right-3 flex items-center gap-2 text-slate-400 hover:text-white transition-colors p-2 rounded-md bg-slate-800/50 backdrop-blur-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg>
                            <span>Copy</span>
                        </button>
                        <div class="code-block">
<pre><code><span style="color: #8b949e;">// lesson_22_chaining_task_and_chat.mjs</span>
<span style="color: #8b949e;">// Merci SDK Tutorial: Lesson 22 - Chaining Task and Chat APIs for Code Review</span>

<span style="color: #8b949e;">// --- IMPORTS ---</span>
<span style="color: #ff7b72;">import</span> { MerciClient, createUserMessage } <span style="color: #ff7b72;">from</span> <span style="color: #a5d6ff;">'../lib/merci.2.14.0.mjs'</span>;
<span style="color: #ff7b72;">import</span> { token } <span style="color: #ff7b72;">from</span> <span style="color: #a5d6ff;">'../secret/token.mjs'</span>;

<span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">TASK_ID</span> = <span style="color: #a5d6ff;">'code-generate:default'</span>;
<span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">REVIEW_MODEL</span> = <span style="color: #a5d6ff;">'openai-gpt-5-mini'</span>;

<span style="color: #ff7b72;">async</span> <span style="color: #ff7b72;">function</span> <span style="color: #d2a8ff;">main</span>() {
    <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`--- Merci SDK Tutorial: Lesson 22 - Chaining Task and Chat APIs ---`</span>);

    <span style="color: #ff7b72;">try</span> {
        <span style="color: #8b949e;">// --- STEP 1: INITIALIZE THE CLIENT ---</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'[STEP 1] Initializing MerciClient...'</span>);
        <span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">client</span> = <span style="color: #ff7b72;">new</span> <span style="color: #d2a8ff;">MerciClient</span>({ token });

        <span style="color: #8b949e;">// === PART 1: GENERATE CODE USING THE TASK API ===</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`\n--- PART 1: Generating Code with Task API (</span><span style="color: #79c0ff;">${TASK_ID}</span><span style="color: #a5d6ff;">) ---`</span>);

        <span style="color: #8b949e;">// --- STEP 2: DEFINE TASK PARAMETERS ---</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'[STEP 2] Defining parameters for a slightly flawed function...'</span>);
        <span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">taskParameters</span> = {
            <span style="color: #c9d1d9;">instructions:</span> <span style="color: #a5d6ff;">"Write a JavaScript function called 'add' that takes two parameters, 'a' and 'b', and returns their sum. Do not include any type checking."</span>,
            <span style="color: #c9d1d9;">language:</span> <span style="color: #a5d6ff;">"javascript"</span>,
            <span style="color: #c9d1d9;">prefix:</span> <span style="color: #a5d6ff;">""</span>,
            <span style="color: #c9d1d9;">suffix:</span> <span style="color: #a5d6ff;">""</span>
        };

        <span style="color: #8b949e;">// --- STEP 3: EXECUTE THE TASK ---</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`[STEP 3] Executing task "</span><span style="color: #79c0ff;">${TASK_ID}</span><span style="color: #a5d6ff;">"...`</span>);
        <span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">taskResult</span> = <span style="color: #ff7b72;">await</span> <span style="color: #79c0ff;">client</span>.<span style="color: #c9d1d9;">tasks</span>.<span style="color: #d2a8ff;">execute</span>(TASK_ID, taskParameters);
        <span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">generatedCode</span> = <span style="color: #79c0ff;">taskResult</span>.<span style="color: #c9d1d9;">content</span>;
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'[INFO] Code generation finished.'</span>);
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`\n--- Generated Code ---\n</span><span style="color: #79c0ff;">${generatedCode}</span><span style="color: #a5d6ff;">\n----------------------`</span>);

        <span style="color: #8b949e;">// === PART 2: REVIEW THE GENERATED CODE USING THE CHAT API ===</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`\n--- PART 2: Reviewing Code with Chat API (</span><span style="color: #79c0ff;">${REVIEW_MODEL}</span><span style="color: #a5d6ff;">) ---`</span>);

        <span style="color: #8b949e;">// --- STEP 4: CREATE A PROMPT FOR THE REVIEWER AGENT ---</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'[STEP 4] Creating a code review prompt...'</span>);
        <span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">reviewPrompt</span> = <span style="color: #a5d6ff;">`
        You are an expert code reviewer.
        Please review the following JavaScript code. Identify any potential issues, suggest improvements for production readiness (like type checking or error handling), and provide a revised, more robust version of the code.

        CODE TO REVIEW:
        '''javascript
        </span><span style="color: #79c0ff;">${generatedCode}</span><span style="color: #a5d6ff;">
        '''
        `</span>;

        <span style="color: #8b949e;">// --- STEP 5: CONFIGURE AND RUN THE CHAT SESSION ---</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'[STEP 5] Configuring and running the chat session for review...'</span>);
        <span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">chatSession</span> = <span style="color: #79c0ff;">client</span>.<span style="color: #c9d1d9;">chat</span>.<span style="color: #d2a8ff;">session</span>(REVIEW_MODEL);
        <span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">messages</span> = [<span style="color: #d2a8ff;">createUserMessage</span>(reviewPrompt)];

        <span style="color: #ff7b72;">let</span> <span style="color: #79c0ff;">finalResponse</span> = <span style="color: #a5d6ff;">''</span>;
        <span style="color: #c9d1d9;">process</span>.<span style="color: #c9d1d9;">stdout</span>.<span style="color: #d2a8ff;">write</span>(<span style="color: #a5d6ff;">'🤖 Code Reviewer > '</span>);
        <span style="color: #ff7b72;">for</span> <span style="color: #ff7b72;">await</span> (<span style="color: #ff7b72;">const</span> <span style="color: #79c0ff;">event</span> <span style="color: #ff7b72;">of</span> <span style="color: #79c0ff;">chatSession</span>.<span style="color: #d2a8ff;">stream</span>(messages)) {
            <span style="color: #ff7b72;">if</span> (<span style="color: #79c0ff;">event</span>.<span style="color: #c9d1d9;">type</span> === <span style="color: #a5d6ff;">'text'</span>) {
                <span style="color: #c9d1d9;">process</span>.<span style="color: #c9d1d9;">stdout</span>.<span style="color: #d2a8ff;">write</span>(<span style="color: #79c0ff;">event</span>.<span style="color: #c9d1d9;">content</span>);
                finalResponse += <span style="color: #79c0ff;">event</span>.<span style="color: #c9d1d9;">content</span>;
            }
        }
        <span style="color: #c9d1d9;">process</span>.<span style="color: #d2a8ff;">stdout</span>.<span style="color: #d2a8ff;">write</span>(<span style="color: #a5d6ff;">''</span>);
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`\n[INFO] Code review finished.`</span>);

        <span style="color: #8b949e;">// --- FINAL RESULT ---</span>
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`\n\n--- FINAL RESULT ---`</span>);
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'This lesson demonstrated a powerful workflow:'</span>);
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'1. The Task API was used for a specialized generation task.'</span>);
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">'2. The Chat API was used for a creative, analytical task (code review).'</span>);
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">log</span>(<span style="color: #a5d6ff;">`\nThis pattern of chaining different APIs together allows for building highly sophisticated applications.`</span>);

    } <span style="color: #ff7b72;">catch</span> (error) {
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">error</span>(<span style="color: #a5d6ff;">`\n\n[FATAL ERROR] An error occurred during the operation.`</span>);
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">error</span>(<span style="color: #a5d6ff;">'  Message:'</span>, error.message);
        <span style="color: #ff7b72;">if</span> (error.status) {
            <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">error</span>(<span style="color: #a5d6ff;">'  API Status:'</span>, error.status);
        }
        <span style="color: #ff7b72;">if</span> (error.details) {
            <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">error</span>(<span style="color: #a5d6ff;">'  Details:'</span>, JSON.<span style="color: #d2a8ff;">stringify</span>(error.details, <span style="color: #ff7b72;">null</span>, <span style="color: #a5d6ff;">2</span>));
        }
        <span style="color: #c9d1d9;">console</span>.<span style="color: #d2a8ff;">error</span>(<span style="color: #a5d6ff;">`\n  Possible causes: Invalid token, network issues, or an API service problem.`</span>);
        <span style="color: #c9d1d9;">process</span>.<span style="color: #d2a8ff;">exit</span>(<span style="color: #a5d6ff;">1</span>);
    }
}

<span style="color: #d2a8ff;">main</span>().<span style="color: #d2a8ff;">catch</span>(<span style="color: #c9d1d9;">console</span>.error);
</code></pre>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Expected Output</h2>
                    <p class="text-[var(--text-secondary)] mb-4">The output shows the two-part process: first, the code generated by the Task API, and second, the detailed code review provided by the Chat API, highlighting how these two distinct APIs can be chained together to build sophisticated applications.</p>
                    <div class="code-block-wrapper">
                        <button class="copy-code-btn absolute top-3 right-3 flex items-center gap-2 text-slate-400 hover:text-white transition-colors p-2 rounded-md bg-slate-800/50 backdrop-blur-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg>
                            <span>Copy</span>
                        </button>
                        <div class="code-block">
<pre><code>--- PART 1: Generating Code with Task API (code-generate:default) ---
[INFO] Code generation finished.
--- Generated Code ---
function add(a, b) {
  return a + b;
}
----------------------

--- PART 2: Reviewing Code with Chat API (openai-gpt-5-mini) ---
🤖 Code Reviewer > Of course. Here is a review of the provided JavaScript code.

### Issues Identified

1.  **No Type Checking**: The function will produce unexpected results if non-numeric types are passed (e.g., `add("2", 3)` results in `"23"`).
2.  **No Error Handling**: The function does not handle cases where arguments are missing or invalid.

### Revised Code

Here is a more robust version of the function:

```javascript
/**
 * Adds two numbers together.
 * @param {number} a The first number.
 * @param {number} b The second number.
 * @returns {number} The sum of the two numbers.
 * @throws {TypeError} If either argument is not a number.
 */
function add(a, b) {
  if (typeof a !== 'number' || typeof b !== 'number') {
    throw new TypeError('Both arguments must be numbers.');
  }
  return a + b;
}
```

[INFO] Code review finished.
</code></pre>
                        </div>
                    </div>
                </section>
            </article>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-[var(--border-color)] bg-[var(--card-background)] transition-colors duration-300">
        <div class="container mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-[var(--text-secondary)]">© 2025 Lukáš Michna (Mobeetle). All rights reserved.</p>
        </div>
    </footer>
</div>

<script src="../assets/js/script.js"></script>
</body>
</html>
</html>